// @bun
import{fileURLToPath as J}from"url";import{rolldown as K}from"rolldown";var M=J(new URL("./files",import.meta.url).href);function N(B={}){let{out:q="build",precompress:C=!0,envPrefix:E="",serveAssets:F=!0}=B;return{name:"svelte-adapter-bun",async adapt(j){let z=j.getBuildDirectory("adapter-bun");if(j.rimraf(q),j.rimraf(z),j.mkdirp(z),j.log.minor("Copying assets"),j.writeClient(`${q}/client${j.config.kit.paths.base}`),j.writePrerendered(`${q}/prerendered${j.config.kit.paths.base}`),C)j.log.minor("Compressing assets"),await Promise.all([j.compress(`${q}/client`),j.compress(`${q}/prerendered`)]);j.log.minor("Building server"),j.writeServer(z),Bun.write(`${z}/manifest.js`,[`export const manifest = ${j.generateManifest({relativePath:"./"})};`,`export const prerendered = new Set(${JSON.stringify(j.prerendered.paths)});`,`export const base = ${JSON.stringify(j.config.kit.paths.base)};`].join(`

`));let G=await Bun.file("package.json").json(),D={index:`${z}/index.js`,manifest:`${z}/manifest.js`};if(j.hasServerInstrumentationFile?.())D["instrumentation.server"]=`${z}/instrumentation.server.js`;if(await(await K({input:D,external:[...Object.keys(G.dependencies||{}).map((I)=>new RegExp(`^${I}(\\/.*)?$`)),/^node:/]})).write({dir:`${q}/server`,format:"esm",sourcemap:!0,chunkFileNames:"chunks/[name]-[hash].js"}),await O(`${q}/server/index.js`),j.copy(M,q,{replace:{ENV:"./env.js",HANDLER:"./handler.js",MANIFEST:"./server/manifest.js",SERVER:"./server/index.js",ENV_PREFIX:JSON.stringify(E),BUILD_OPTIONS:JSON.stringify({serveAssets:F})}}),j.hasServerInstrumentationFile?.())j.instrument?.({entrypoint:`${q}/index.js`,instrumentation:`${q}/server/instrumentation.server.js`,module:{exports:["path","host","port","server"]}})},supports:{read:()=>!0,instrumentation:()=>!0}}}async function O(B){let C=(await Bun.file(B).text()).replace(/(const (.*?) = await get_hooks\(\);)\s+(this\.#options\.hooks\s+=\s+{)/,"$1$3websocket: $2.websocket || null,").replace(/(async function get_hooks\(\) {)/,"$1let websocket;").replace(/(\({handle,)((.|\s)*?{)/,"$1websocket,$2websocket,").replace(/(async init\({ env, read }\) {)/,`websocket() {return this.#options.hooks.websocket}
$1`);Bun.write(B,C)}export{N as default};
